<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8" />
  <title>DreamCatcher</title>
  <style type="text/css">
    body {
      margin: 0;
      padding: 0;
      background: #000000;
    }
  </style>
</head>
<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.2/phaser.min.js"></script>
  <script>
    var TeclaPresionada = false;
    var MeteoritosTotales = 80; //cantidad de meteoritos animados
    var MeteoritosIndestructibles = 15;
    var EstrellasTotales = 100;  //cantidad de estrellas animadas en fondo
    var GemasTotales = 15; //total de gemas a recolectar

    EstadosGalaxyGem = {
      init: function () {
        GalaxyGem.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL; 
        GalaxyGem.scale.pageAlignHorizontally = true; 
        GalaxyGem.scale.pageAlignVertically = true; 
        this.BIMPresionado = false; //inicia el juego al dar clic en la pantalla
        this.MeteoritosImpactados = 0; 
        this.JuegoTerminado = false; 
      },

      preload: function () {
        // Utilizar img de la selva de fondo
        this.load.image('fondo', 'assets/background/selva.jpg');

        // Red para atrapar los bichos
        this.load.image('nave', 'assets/naves/red_arriba.png');
        this.load.image('nave1', 'assets/naves/red_arriba.png');
        this.load.image('nave2', 'assets/naves/red_der.png');
        this.load.image('nave3', 'assets/naves/red_izq.png');
        this.load.image('nave4', 'assets/naves/red_abajo.png');

        // Meteorito normal
        this.load.image('meteoritos', 'assets/enemies/Araña1.png');

        // Meteorito indestructible
        let meteorito2Graphic = GalaxyGem.add.bitmapData(40, 40);
        this.load.image('meteoritos2', 'assets/enemies/Araña3.png');

        //Audio
        this.load.audio('musicaFondo', 'assets/audio/musica_ambiente.mp3');
        this.load.audio('sonidoMariposa', 'assets/audio/mariposa_especial.mp3');
        this.load.audio('sonidoGanador', 'assets/audio/victoria_sonido.mp3')
        this.load.audio('sonidoPerdedor', 'assets/audio/derrota_sonido.mp3')
        this.load.audio('sonidoCapturar', 'assets/audio/red_movimiento.mp3')
        
        // Explosión
        let explosionGraphic = GalaxyGem.add.bitmapData(60, 60);
        explosionGraphic.ctx.fillStyle = '#ff9800';
        explosionGraphic.ctx.beginPath();
        explosionGraphic.ctx.arc(30, 30, 25, 0, Math.PI * 2);
        explosionGraphic.ctx.fill();
        explosionGraphic.ctx.fillStyle = '#ffeb3b';
        explosionGraphic.ctx.beginPath();
        explosionGraphic.ctx.arc(30, 30, 15, 0, Math.PI * 2);
        explosionGraphic.ctx.fill();
        GalaxyGem.cache.addBitmapData('explosion', explosionGraphic);

        // Explosión 2
        let explosion2Graphic = GalaxyGem.add.bitmapData(80, 80);
        explosion2Graphic.ctx.fillStyle = '#f44336';
        explosion2Graphic.ctx.beginPath();
        explosion2Graphic.ctx.arc(40, 40, 35, 0, Math.PI * 2);
        explosion2Graphic.ctx.fill();
        explosion2Graphic.ctx.fillStyle = '#ff9800';
        explosion2Graphic.ctx.beginPath();
        explosion2Graphic.ctx.arc(40, 40, 25, 0, Math.PI * 2);
        explosion2Graphic.ctx.fill();
        explosion2Graphic.ctx.fillStyle = '#ffeb3b';
        explosion2Graphic.ctx.beginPath();
        explosion2Graphic.ctx.arc(40, 40, 15, 0, Math.PI * 2);
        explosion2Graphic.ctx.fill();
        GalaxyGem.cache.addBitmapData('explosion2', explosion2Graphic);


        // Particulas
        for (let i = 1; i <= 3; i++) {
          let estrellaGraphic = GalaxyGem.add.bitmapData(10, 10);
          let color = GalaxyGem.rnd.pick(['#ffffff', '#e3f2fd', '#bbdefb']);
          estrellaGraphic.ctx.fillStyle = color;
          estrellaGraphic.ctx.beginPath();
          estrellaGraphic.ctx.arc(5, 5, 3, 0, Math.PI * 2);
          estrellaGraphic.ctx.fill();
          GalaxyGem.cache.addBitmapData('estrella' + i, estrellaGraphic);
        }

        // Coleccionable
        this.load.image('gema', 'assets/Coleccionables/Mariposa.png');

        // Proyectil
        this.load.image('proyectil', 'assets/Proyectil/proyectil.png');

        // Platillos
        let platillobajoGraphic = GalaxyGem.add.bitmapData(100, 40);
        platillobajoGraphic.ctx.fillStyle = '#9c27b0';
        platillobajoGraphic.ctx.beginPath();
        platillobajoGraphic.ctx.ellipse(50, 20, 45, 15, 0, 0, Math.PI * 2);
        platillobajoGraphic.ctx.fill();
        platillobajoGraphic.ctx.strokeStyle = '#e1bee7';
        platillobajoGraphic.ctx.lineWidth = 2;
        platillobajoGraphic.ctx.stroke();
        GalaxyGem.cache.addBitmapData('platillobajo', platillobajoGraphic);

        let platilloarribaGraphic = GalaxyGem.add.bitmapData(100, 40);
        platilloarribaGraphic.ctx.fillStyle = '#9c27b0';
        platilloarribaGraphic.ctx.beginPath();
        platilloarribaGraphic.ctx.ellipse(50, 20, 45, 15, 0, 0, Math.PI * 2);
        platilloarribaGraphic.ctx.fill();
        platilloarribaGraphic.ctx.strokeStyle = '#e1bee7';
        platilloarribaGraphic.ctx.lineWidth = 2;
        platilloarribaGraphic.ctx.stroke();
        GalaxyGem.cache.addBitmapData('platilloarriba', platilloarribaGraphic);
      },

      create: function () {
        GalaxyGem.add.sprite(0, 0, 'fondo');

        this.EstrellasArray = [];
        for (var i = 0; i < EstrellasTotales; i++) {
          var PosX = GalaxyGem.rnd.integerInRange(1, 1200);
          var PosY = GalaxyGem.rnd.integerInRange(1, 700);
          var estrellas = GalaxyGem.add.sprite(
            PosX,
            PosY,
            GalaxyGem.cache.getBitmapData('estrella' + GalaxyGem.rnd.integerInRange(1, 3))
          );
          estrellas.vel = 0.3 + GalaxyGem.rnd.frac() * 3;
          estrellas.alpha = GalaxyGem.rnd.frac() + 1;
          estrellas.scale.setTo(0.1 + GalaxyGem.rnd.frac() / 4);
          this.EstrellasArray[i] = estrellas;
        }

        // Creación y distribución de gemas
        this.GemasArray = [];
        for (var i = 0; i < GemasTotales; i++) {
          var PosX = GalaxyGem.rnd.integerInRange(1, 1200);
          var PosY = GalaxyGem.rnd.integerInRange(-800, -100);
          
          var Gemas = GalaxyGem.add.sprite(PosX, PosY, 'gema'); // ← reemplazo acá
          Gemas.anchor.setTo(0.5);
          Gemas.scale.setTo(0.2); // opcional: ajustá el tamaño si se ve muy grande
          Gemas.vel = 1 + GalaxyGem.rnd.frac() * 5;
          
          this.GemasArray[i] = Gemas;
        }
        


        // Naves (direcciones)
        this.nave4 = this.add.image(0, 0, 'nave4');
        this.nave4.x = GalaxyGem.width / 2;
        this.nave4.y = GalaxyGem.height / 2;
        this.nave4.anchor.setTo(0.5);

        this.nave3 = this.add.image(0, 0, 'nave3');
        this.nave3.x = GalaxyGem.width / 2;
        this.nave3.y = GalaxyGem.height / 2;
        this.nave3.anchor.setTo(0.5);

        this.nave2 = this.add.image(0, 0, 'nave2');
        this.nave2.x = GalaxyGem.width / 2;
        this.nave2.y = GalaxyGem.height / 2;
        this.nave2.anchor.setTo(0.5);

        this.nave1 = this.add.image(0, 0, 'nave1');
        this.nave1.x = GalaxyGem.width / 2;
        this.nave1.y = GalaxyGem.height / 2;
        this.nave1.anchor.setTo(0.5);

        this.nave = this.add.image(0, 0, 'nave');
        this.nave.x = GalaxyGem.width / 2;
        this.nave.y = GalaxyGem.height / 2;
        this.nave.anchor.setTo(0.5);

        this.nave.scale.setTo(0.5);
        this.nave1.scale.setTo(0.5);
        this.nave2.scale.setTo(0.5);
        this.nave3.scale.setTo(0.5);
        this.nave4.scale.setTo(0.5);

        // Ocultar las otras variantes por defecto
        this.nave1.visible = false;
        this.nave2.visible = false;
        this.nave3.visible = false;
        this.nave4.visible = false;

        // Input
        GalaxyGem.input.onDown.add(this.onTap, this);

        // Meteoritos normales
        this.meteoritos = [];
        for (var i = 0; i < MeteoritosTotales; i++) {
          var meteorito = GalaxyGem.add.sprite(0, 0, 'meteoritos'); // <-- cambia esto
          meteorito.scale.setTo(0.2 + GalaxyGem.rnd.frac() * 0.5);
          meteorito.anchor.setTo(0.5);
          meteorito.x = GalaxyGem.rnd.integerInRange(1, 1270);
          meteorito.y = GalaxyGem.rnd.integerInRange(-400, -100);
          meteorito.vel = 3 + GalaxyGem.rnd.frac() * 2;
          meteorito.rotation = GalaxyGem.rnd.frac() * Math.PI * 2;
          this.meteoritos[i] = meteorito;
        }

        // Meteoritos indestructibles
        this.MeteoritosIndestructibles = [];
        for (var i = 0; i < MeteoritosIndestructibles; i++) {
          var MeteoritoIndestructible = GalaxyGem.add.sprite(0, 0, 'meteoritos2'); // <-- cambia esto
          MeteoritoIndestructible.scale.setTo(0.2 + GalaxyGem.rnd.frac() * 1);
          MeteoritoIndestructible.anchor.setTo(0.5);
          MeteoritoIndestructible.x = GalaxyGem.rnd.integerInRange(1, 1270);
          MeteoritoIndestructible.y = GalaxyGem.rnd.integerInRange(-400, -100);
          MeteoritoIndestructible.vel = 3 + GalaxyGem.rnd.frac() * 2;
          MeteoritoIndestructible.rotation = GalaxyGem.rnd.frac() * Math.PI * 2;
          this.MeteoritosIndestructibles[i] = MeteoritoIndestructible;
        }


        // Grupo de explosiones
        this.explosionGroup = GalaxyGem.add.group();
        for (var i = 0; i < 10; i++) {
          this.explosion = this.explosionGroup.create(100, 100, GalaxyGem.cache.getBitmapData('explosion'));
          this.explosion.tweenScale = GalaxyGem.add.tween(this.explosion.scale).to({
            x: [0.5, 1, 0.7],
            y: [0.5, 1, 0.7]
          }, 600, Phaser.Easing.Exponential.Out, false, 0, 0, false);
          this.explosion.tweenAlpha = GalaxyGem.add.tween(this.explosion).to({
            alpha: [1, 0.6, 0.2]
          }, 600, Phaser.Easing.Exponential.Out, false, 0, 0, false);
          this.explosion.anchor.setTo(0.5);
          this.explosion.kill();
        }

        // Grupo de explosiones 2
        this.explosionGroup2 = GalaxyGem.add.group();
        this.explosion = this.explosionGroup2.create(100, 100, GalaxyGem.cache.getBitmapData('explosion2'));
        this.explosion.tweenScale = GalaxyGem.add.tween(this.explosion.scale).to({
          x: [0.5, 1, 0.7],
          y: [0.5, 1, 0.7]
        }, 600, Phaser.Easing.Exponential.Out, false, 0, 0, false);
        this.explosion.tweenAlpha = GalaxyGem.add.tween(this.explosion).to({
          alpha: [1, 0.6, 0.2]
        }, 600, Phaser.Easing.Exponential.Out, false, 0, 0, false);
        this.explosion.anchor.setTo(0.5);
        this.explosion.kill();

        var bgAlpha1 = GalaxyGem.add.bitmapData(GalaxyGem.width, 50);
        bgAlpha1.ctx.fillStyle = '#000000';
        bgAlpha1.ctx.fillRect(0, 0, GalaxyGem.width, 50);
        var bg1 = GalaxyGem.add.sprite(0, 0, bgAlpha1);
        bg1.alpha = 0.7;

        this.currentScore = 0;
        var style = {
          font: 'bold 20pt Arial',
          fill: '#FFEE55',
          align: 'center'
        };

        this.PuntajeActualGema = 0;
        var style2 = {
          font: 'bold 20pt Arial',
          fill: '#FF5950',
          align: 'center'
        };

        var style3 = {
          font: 'bold 20pt Arial',
          fill: '#42A5F5',
          align: 'center'
        };

        this.PuntajeGem = GalaxyGem.add.text(GalaxyGem.width / 2, 30, 'Mariposas: 0/15', style2);
        this.PuntajeGem.anchor.setTo(0.5);

        this.SaludActualNave = 100; 
        this.TextoSaludNave = GalaxyGem.add.text(150, 30, 'Salud: ' + 100, style);
        this.TextoSaludNave.anchor.setTo(0.5);

        this.totalTime = 60;
        this.timerText = GalaxyGem.add.text(GalaxyGem.width - 200, 30, 'Tiempo: ' + this.totalTime, style3);
        this.timerText.anchor.setTo(0.5);
        this.timerGameOver = GalaxyGem.time.events.loop(Phaser.Timer.SECOND, function () {
          this.totalTime--;
          this.timerText.text = 'Tiempo: ' + this.totalTime;
          if (this.totalTime <= 0) {
            GalaxyGem.time.events.remove(this.timerGameOver);
            this.JuegoTerminado = true;
            this.showFinalMessage('Lo sentimos, el tiempo se agoto \n Presiona F5 o recarga la ventana para reiniciar');
          }
        }, this);

        this.cursor = this.input.keyboard.createCursorKeys();

        //--- CAMBIOS PARA BALAS REPETITIVAS ---
        // 1) Creamos un grupo de balas (en vez de un solo proyectil).
        this.bulletGroup = GalaxyGem.add.group();

        // Creamos varias balas "muertas" para usarlas cuando disparamos
        for (var b = 0; b < 30; b++) {
          let bullet = this.bulletGroup.create(0, 0, 'proyectil'); // <- cambio acá
          bullet.anchor.setTo(0.5);
          bullet.scale.setTo(0.1); // opcional: ajustá el tamaño si es muy grande
          bullet.kill(); // para que no se vean hasta que se disparen
        }

        // Control de intervalo de disparo (cada 300 ms)
        this.bulletTime = 0;
        this.bulletInterval = 200;

        //Audio de fondo       
        GalaxyGem.input.onDown.addOnce(function() {
          this.musica = GalaxyGem.add.audio('musicaFondo');
          this.musica.loopFull(0.3);
          this.musica.loop = true; // Hace que se repita
          this.musica.play();
      }, this);
      

      },

      increaseScore: function () {
        this.sonidoCapturar = GalaxyGem.add.audio('sonidoCapturar')
        this.sonidoCapturar.play();
        this.TextoSaludNave.text = 'Salud: ' + this.SaludActualNave;
        this.MeteoritosImpactados += 1;
        if (this.SaludActualNave < 0) {
          GalaxyGem.time.events.remove(this.timerGameOver);
          this.JuegoTerminado = true;
          this.showFinalMessage('!PERDISTE! \n Las Arañas te mordieron \n Presiona F5 o recarga la ventana para reiniciar');
          this.sonidoPerdedor = GalaxyGem.add.audio('sonidoPerdedor');
          this.sonidoPerdedor.play();
        }
      },

      GemasPuntajeIncremento: function () {
        this.PuntajeActualGema += 1;
        this.PuntajeGem.text = 'Mariposas: ' + this.PuntajeActualGema + '/15';
        this.TextoSaludNave.text = 'Salud: ' + this.SaludActualNave;
        this.sonidoMariposa = GalaxyGem.add.audio('sonidoMariposa');
        this.sonidoMariposa.play();

        if (this.PuntajeActualGema >= GemasTotales) {
          GalaxyGem.time.events.remove(this.timerGameOver);
          this.JuegoTerminado = true;
          this.showFinalMessage('¡Felicidades! \n Salvaste a todas las Mariposas \n Presiona F5 o recarga la ventana para reiniciar');
          this.sonidoGanador = GalaxyGem.add.audio('sonidoGanador');
          this.sonidoGanador.play();
        }
      },

      showFinalMessage: function (msg) {
        var bgAlpha = GalaxyGem.add.bitmapData(GalaxyGem.width, GalaxyGem.height);
        bgAlpha.ctx.fillStyle = '#000000';
        bgAlpha.ctx.fillRect(0, 0, GalaxyGem.width, GalaxyGem.height);
        var bg = GalaxyGem.add.sprite(0, 0, bgAlpha);
        bg.alpha = 0.3;

        var style = {
          font: 'bold 30pt Arial',
          fill: '#4CC9F0',
          align: 'center'
        };
        if (this.totalTime <= 0) {
          style.fill = '#fc3f7';
        }
        if (this.SaludActualNave <= 0) {
          style.fill = '#ff7043';
        }
        this.textFieldFinalMsg = GalaxyGem.add.text(GalaxyGem.width / 2, GalaxyGem.height / 2, msg, style);
        this.textFieldFinalMsg.anchor.setTo(0.5);
      },

      onTap: function () {
        this.BIMPresionado = true;
      },

      // Función para disparar una bala
      fireBullet: function () {
        // Buscamos la primera bala "muerta"
        let bullet = this.bulletGroup.getFirstDead();
        if (bullet) {
          // La revivimos en la posición actual de la nave
          bullet.reset(this.nave.x, this.nave.y);
        }
      },

      // Funciones de colisión
      getBoundsmeteorito: function (currentmeteorito) {
        return new Phaser.Rectangle(
          currentmeteorito.left,
          currentmeteorito.top,
          currentmeteorito.width,
          currentmeteorito.height
        );
      },

      getBoundsGemas: function (currentGema) {
        return new Phaser.Rectangle(
          currentGema.left,
          currentGema.top,
          currentGema.width,
          currentGema.height
        );
      },

      isRectanglesOverlapping: function (rect1, rect2) {
        if (rect1.x > rect2.x + rect2.width || rect2.x > rect1.x + rect1.width) {
          return false;
        }
        if (rect1.y > rect2.y + rect2.height || rect2.y > rect1.y + rect1.height) {
          return false;
        }
        return true;
      },

      getBoundsnave: function () {
        var x0 = this.nave.x - Math.abs(this.nave.width) / 4;
        var width = this.nave.width / 2;
        var y0 = this.nave.y - this.nave.height / 2;
        var height = this.nave.height;
        return new Phaser.Rectangle(x0 + 20, y0 + 20, width - 30, height - 30);
      },

      update: function () {
        if (this.BIMPresionado && !this.JuegoTerminado) {
          this.nave.visible = true;
          this.nave1.visible = false;
          this.nave2.visible = false;
          this.nave3.visible = false;
          this.nave4.visible = false;

          if (this.cursor.right.isDown && this.nave.x + this.nave.width / 2 <= GalaxyGem.width) {
            this.nave.x += 10;
            this.nave.visible = false;
            this.nave2.visible = true;
            this.nave2.x = this.nave.x;
            this.nave2.y = this.nave.y;
          }
          else if (this.cursor.left.isDown && this.nave.x >= this.nave.width / 2) {
            this.nave.x -= 10;
            this.nave.visible = false;
            this.nave3.visible = true;
            this.nave3.x = this.nave.x;
            this.nave3.y = this.nave.y;
          }
          else if (this.cursor.up.isDown && this.nave.y >= this.nave.height / 2) {
            this.nave.y -= 10;
            this.nave.visible = false;
            this.nave1.visible = true;
            this.nave1.x = this.nave.x;
            this.nave1.y = this.nave.y;
          }
          else if (this.cursor.down.isDown && this.nave.y + this.nave.height / 2 <= GalaxyGem.height) {
            this.nave.y += 10;
            this.nave.visible = false;
            this.nave4.visible = true;
            this.nave4.x = this.nave.x;
            this.nave4.y = this.nave.y;
          }

          //--- CAMBIOS PARA BALAS REPETITIVAS ---
          // 2) Disparamos automáticamente cada 300ms
          if (GalaxyGem.time.now > this.bulletTime) {
            this.fireBullet(); 
            this.bulletTime = GalaxyGem.time.now + this.bulletInterval;
          }

          // 3) Mover cada bala hacia arriba. Si sale de la pantalla, la matamos
          this.bulletGroup.forEachAlive(function (bullet) {
            bullet.y -= 10; // velocidad vertical
            if (bullet.y < -50) {
              bullet.kill();
            }
          }, this);

          // Mover estrellas
          for (var i = 0; i < EstrellasTotales; i++) {
            var estrellas = this.EstrellasArray[i];
            estrellas.y += estrellas.vel;
            if (estrellas.y > GalaxyGem.height + 50) {
              estrellas.y = GalaxyGem.rnd.integerInRange(-200, 0);
              estrellas.x = GalaxyGem.rnd.integerInRange(1, 1270);
            }
          }

          // Mover meteoritos normales
          for (var i = 0; i < MeteoritosTotales; i++) {
            var meteorito1 = this.meteoritos[i];
            meteorito1.y += meteorito1.vel;
            if (meteorito1.y > GalaxyGem.height + 100) {
              meteorito1.y = GalaxyGem.rnd.integerInRange(-300, 0);
              meteorito1.x = GalaxyGem.rnd.integerInRange(1, 1270);
            }
          }

          // Mover meteoritos indestructibles
          for (var i = 0; i < MeteoritosIndestructibles; i++) {
            var meteorito2 = this.MeteoritosIndestructibles[i];
            meteorito2.y += meteorito2.vel;
            if (meteorito2.y > GalaxyGem.height + 100) {
              meteorito2.y = GalaxyGem.rnd.integerInRange(-300, 0);
              meteorito2.x = GalaxyGem.rnd.integerInRange(1, 1270);
            }
          }

          // Mover gemas
          for (var i = 0; i < GemasTotales; i++) {
            var Gema1 = this.GemasArray[i];
            Gema1.y += Gema1.vel;
            if (Gema1.y > GalaxyGem.height + 50) {
              Gema1.y = GalaxyGem.rnd.integerInRange(-500, 100);
              Gema1.x = GalaxyGem.rnd.integerInRange(1, 1270);
            }
          }


          // Colisión NAVE - METEORITOS NORMALES
          for (var i = 0; i < MeteoritosTotales; i++) {
            var rectnave = this.getBoundsnave();
            var rectmeteorito = this.getBoundsmeteorito(this.meteoritos[i]);
            if (this.meteoritos[i].visible && this.isRectanglesOverlapping(rectnave, rectmeteorito)) {
              this.SaludActualNave -= Math.trunc(this.meteoritos[i].scale.x * 5);
              this.TextoSaludNave.text = 'Salud: ' + this.SaludActualNave;
              this.increaseScore();
              this.meteoritos[i].visible = false;
              var explosion = this.explosionGroup.getFirstDead();
              if (explosion != null) {
                explosion.reset(this.meteoritos[i].x, this.meteoritos[i].y);
                explosion.tweenScale.start();
                explosion.tweenAlpha.start();
                explosion.tweenAlpha.onComplete.add(function (currentTarget, currentTween) {
                  currentTarget.kill();
                }, this);
              }
            }
          }

          // Colisión NAVE - METEORITOS INDESTRUCTIBLES
          for (var i = 0; i < MeteoritosIndestructibles; i++) {
            var rectnave = this.getBoundsnave();
            var rectmeteorito = this.getBoundsmeteorito(this.MeteoritosIndestructibles[i]);
            if (this.MeteoritosIndestructibles[i].visible && this.isRectanglesOverlapping(rectnave, rectmeteorito)) {
              this.SaludActualNave -= Math.trunc(this.MeteoritosIndestructibles[i].scale.x * 7);
              if (this.SaludActualNave < 0) {
                this.SaludActualNave = 0;
              }
              this.increaseScore();
              this.MeteoritosIndestructibles[i].visible = false;
              var explosion = this.explosionGroup.getFirstDead();
              if (explosion != null) {
                explosion.reset(this.MeteoritosIndestructibles[i].x, this.MeteoritosIndestructibles[i].y);
                explosion.tweenScale.start();
                explosion.tweenAlpha.start();
                explosion.tweenAlpha.onComplete.add(function (currentTarget, currentTween) {
                  currentTarget.kill();
                }, this);
              }
            }
          }

          // Colisión BALAS - METEORITOS NORMALES
          for (var i = 0; i < MeteoritosTotales; i++) {
            var meteorito = this.meteoritos[i];
            if (meteorito.visible) {
              // Recorremos cada bala viva para ver si choca
              this.bulletGroup.forEachAlive(function (bullet) {
                // Bounds "manuales" de la bala
                var rectBullet = new Phaser.Rectangle(
                  bullet.x - bullet.width * 0.5,
                  bullet.y - bullet.height * 0.5,
                  bullet.width,
                  bullet.height
                );
                var rectMeteor = this.getBoundsmeteorito(meteorito);
                if (this.isRectanglesOverlapping(rectBullet, rectMeteor)) {
                  meteorito.visible = false;
                  bullet.kill();
                  var explosion = this.explosionGroup.getFirstDead();
                  if (explosion) {
                    explosion.reset(meteorito.x, meteorito.y);
                    explosion.tweenScale.start();
                    explosion.tweenAlpha.start();
                    explosion.tweenAlpha.onComplete.add(function (currentTarget, currentTween) {
                      currentTarget.kill();
                    }, this);
                  }
                }
              }, this);
            }
          }

          // Colisión NAVE - GEMAS
          for (var i = 0; i < GemasTotales; i++) {
            var rectnave = this.getBoundsnave();
            var rectGemas = this.getBoundsGemas(this.GemasArray[i]);
            if (this.GemasArray[i].visible && this.isRectanglesOverlapping(rectnave, rectGemas)) {
              this.GemasPuntajeIncremento();
              this.SaludActualNave += 3;
              this.GemasArray[i].visible = false;
              var explosion = this.explosionGroup.getFirstDead();
              if (explosion != null) {
                explosion.reset(this.GemasArray[i].x, this.GemasArray[i].y);
                explosion.tweenScale.start();
                explosion.tweenAlpha.start();
                explosion.tweenAlpha.onComplete.add(function (currentTarget, currentTween) {
                  currentTarget.kill();
                }, this);
              }
            }
          }
        }
      }
    }

    alert("¡Da click en el centro de la pantalla para jugar! \n Presiona F5 para reiniciar el juego\n Utiliza las direccionales para moverte");
    var GalaxyGem = new Phaser.Game(1280, 720, Phaser.CANVAS);
    GalaxyGem.state.add('MiJuegoGG', EstadosGalaxyGem);
    GalaxyGem.state.start('MiJuegoGG');
  </script>
</body>
</html>
